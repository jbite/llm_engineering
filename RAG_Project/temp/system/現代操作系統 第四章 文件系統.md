# 第四章 文件系統

文件是一種對長期儲存的資料的操作的抽象，等同於進程、地址空間一樣重要。

文件是進程創建的信息邏輯單元。一個磁盤一般含有幾千甚至幾百萬個文件，每個文件是獨立於其他文件的。

文件也可以看做是一種地址空間。

進程可以讀取已經存在的文件，並在需要時建立新的文件。存儲在文件中的信息必須是持久的，不會因為進程的創建與終止而受到影響。

操作系統負責文件的：構造、命名、存取、使用、保護、實現和管理。

## 4.1 文件

### 4.1.1 文件命名

文件擴展名

### 4.1.2 文件結構

最常見的文件是一種無結構的字節序列，只有用戶程式才會解釋文件。

一種改進是使用固定長度的記錄，讀操作返回一個記錄，而寫操作重寫或追加一個記錄。

還有一種是文件由一顆記錄樹構成，每個記錄並不具有同樣的長度，而記錄的固定位置上有一個鍵字段。這顆樹按鍵字段進行排序，從而對特定鍵進行快速查找。把記錄加在文件的什麼位置是由操作系統決定的。在一些處理商業數據的的型計算機中獲得廣泛使用。

### 4.1.3 文件類型

操作系統支持多種文件類型。如UNIX還有

字符特殊文件(character special file): 和輸出/輸入有關，用於串行I/O類設備，如終端、印表機、網路等。

塊特殊文件(block special file)：用於磁盤類設備。

普通文件：一般分為ASICII文件和二進制文件。

ASCII文件由多行正文組成。每行用enter結束，有些系統用換行符結束。有些使用enter和換行符。文中各行的長度不一定相同。優勢就是可以顯示和列印，還可以用任何的文字編緝器來編緝。也可以用來進行shell管道這種的操作。

二進制文件：顯示就是亂碼，只有使用該文件的程式才了解這種結構。

目錄是管理文件結構的系統文件。

這是一個簡單可執行的二進制文件。有五個段：文件頭、正文、數據、重定位位及符號表。

文件頭以魔數(magic number)開始，表明該文件是一個可執行的文件(防止非這種格式的文件偶然運行)。魔數後面是文件中各段的長度、執行的起始地址和一些標誌位。

正文及數據會被裝入記憶體，並使用重定位位重新定位。

符號表則用於調試。

二進制文件的第二個例子是UNIX的存檔文件，它由已編譯但沒有連接的庫過程集合而成。每個文件以模塊開始，其中記錄了名稱、創建日期、所有者、保護碼和文件大小。

所有操作系統必須能夠識別它們自己的可執行文件類型，其中有些操作系統還可識別更多的信息。

### 4.1.4 文件存取

早期只有一種文件存取方式：順序存取(squential access)。進程有這些系統中可從頭順序讀取文件的全部字節或記錄，但不能跳過某一些內容，也不能不按順序讀取。順序存取文件是可以返回到起點的，需要時可多次讀取該文件。在存儲介質是磁帶而不是磁盤時，順序存取文件是很方便的。

當用磁盤來存儲文件時，我們可以不按順序地讀取文件中的定節或記錄，或者按照關鍵字而不是位置來存取記錄。這種能夠以任何次序讀取其中字節或記錄的文件稱為隨機存取文件(random access file)

對很多應用而言，隨機存取文件是不可少的，如資料庫系統。如果乘客打電話預訂某航班機票，訂票程序必須能直接存取該航班記錄，而不必先讀出其他航班的成千上萬個記錄。

有兩種方法可以指示從何處開始讀取文件。

一、每次read操作都給出開始讀文件的位置

二、用一個特殊的seek操作設置當前位置，在seek操作後，從這個當前位置順序地開始讀文件。windows和UNIX使用的。

### 4.1.5 文件屬性

常見的屬性：

| **屬性**         | **含義**                             |
| ---------------- | ------------------------------------ |
| 保護             | 誰可以存取文件，以什麼方式取文件     |
| 口令             | 存取文件需要的口令                   |
| 創建者           | 創建文件者的ID                       |
| 所有者           | 當前所有者                           |
| 只讀標誌         | 0表示讀/寫；1表示只讀                |
| 隱藏標誌         | 0表示正常；1表示不在列表中顯示       |
| 系統標誌         | 0表示普通文件；1表示系統文件         |
| 存檔標誌         | 0表示已經備份；1表示需要備份         |
| ASCII/二進制標誌 | 0表示ASCII碼文件；1表示二進制文件    |
| 隨機存取標誌     | 0表示只允許順序存取；1表示隨機存取   |
| 臨時標誌         | 0表示正常；1表示進程退出時刪除該文件 |
| 加鎖標誌         | 0表示未加鎖；非零表示加鎖            |
| 記錄標誌         | 一個記錄中的字節數                   |
| 鍵的位置         | 每個記錄中鍵的偏移量                 |
| 鍵的長度         | 鍵字段的字節數                       |
| 創建時間         | 文件創建的日期和時間                 |
| 最後一次存取時間 | 文件上一次存取的日期和時間           |
| 最後一次修改時間 | 文件上一次修改的日期和時間           |
| 當前大小         | 文件的字節數                         |
| 最大長度         | 文件可能增長到的字節數               |

### 4.1.6文件操作

常見的系統調用：

1：create。創建不包含任何數據的文件。該調用的目的是表示文件即將建立，並設置文件的一些屬性

2 ：delete。當不再需要某個文件時，必須刪除該文件以釋放磁盤空間。

3：open。調用的目的是：把文件屬性和磁盤地址表裝入記憶體，便於後讀調用的快速存取。

4：close。存取結束後，關閉文件以釋放內部表空間。很多系統限制進程打開文件的個數，以鼓勵關閉不再使用的文件。磁盤以塊為單位寫入，關閉文件時，寫入該文件的最後一塊，即使這個塊還沒有滿。

5：read。在文件讀取數據。調用者必須指明需要讀取多少數據，並且提供存放這些數據的緩沖區。

6：write。向文件寫數據，寫操作一般也是從文件當前位置開始。如果當前位置是文件末尾，文件長度增加。如果當前位置在文件中間，則現有數據被覆蓋，並且永遠丟失。

7：append。此調用是write的限制形式，它只能在文件末尾添加數據。

8：seek。對於隨機存取文件，要指定從何處開始取數據，通常的方法是用seek系統調用把當前位置指針指向文件中特定位置。seek調用結束後，就可以從該位置開始讀寫數據

9：get_attributes。進程運行常需要讀取文件屬性。

10：set_attributes。某些屬性是可由用戶設置的，在文件創建之後，用戶還可以通過系統調用set_attributes來修改它們。

11：rename。用戶改變已有文件的名字調用此操作。嚴格來說，設置這個系統調用不是必要的，因為可以先把文件複制到一個新文件名的淆件中，然後刪除原來的文件。

### 4.1.7 使用文件系統調用的一個示例程序

## 4.2 目錄

### 4.2.1 一級目錄系統

這是最簡單的一種目錄，就是目錄中包含所有文件，稱為根目錄。

### 4.2.2 層次目錄系統

使用一個目錄樹，把文件以自然的方式分組。如果多個用戶共享一個文件伺服器，如許多公司的網路系統，每個用戶可以為自己的目錄樹擁有自己的私人根目錄。

用戶也可以創建任意數量的子目錄，這使得用戶組織其工作提供了強大的結構化工具，

### 4.2.3 路徑名

絕對路徑：如果路徑名的第一個字符是分隔符，則這個路徑就是絕對路徑

相對路徑：常和工作目錄(也稱作當前目錄(current directory))一起使用。

### 4.2.4 目錄操作

1）create：創建目錄。除了目錄項 . 和 .. 之外，目錄項為空。這是系統自動放入的。

2）delete：刪除目錄。只有空目錄可刪除。

3）opendir：目錄內容可被讀取。例如，為列出目錄中全部文件，程序必須先打開該目錄，然後讀其中全部文件的文件名。與打開和讀文件相同，在讀目錄前，必須打開目錄。

4）closedir： 讀目錄結束後，應該關閉目錄以釋放內部表空間。
5）readdir：系統調用readdir返回打開目錄的下一個目錄項。以前也採用read系統調用來讀目錄，但這方法有一個缺點：程序員必須了解和處理目錄的內部結構。相反，不論採用哪一種目錄結構，readdir總是以標準格式返回一個目錄項。

6）rename：文件或目錄更換名字。

7）link：鏈接技術允許在多個目錄中出現同一個文件。指定一個存在的文件和一個路徑名，並建立從該文件的i節點（i-node)計數器的計數（記錄含有該文件的目錄項數目），有時稱為硬鏈接。

8）unlink：刪除目錄項。如果被解除連接的文件只出現在一個目錄中，則將它從文件系統中刪除。

符號鏈接：一個文件名指向命名另一個文件的一個小文件。使用這個小文件時，文件系統沿著路徑最終找到文件名。可以跨越硬碟的限制。

## 4.3 文件系統的實現

### 4.3.1 文件系統布局

![image-os-graph4-9](/home/jackyfeng/GoogleDrive/電子書/學習筆記/os-graph4-9.jpg)

文件系統存放在硬碟上。大多硬碟劃分為一個或多個分區，每個分區中有一個獨立的文件系統。

硬碟的0號扇區稱為主引導記錄（Master Boot Record, MBR），用來引導計算機。

在MBR的結尾是分區表，記錄每個分區的起始地址和結束地址。表中的一個分區被標記為活動分區。在計算機被引導時，BIOS讀入並執行MBR。MBR首先確定活動分區，讀入它的第一個塊，稱為引導塊（boot block)，並執行之。

引導塊中的程序將裝載該分區中的操作系統。為統一起見，每個分區都從一個引導塊開始，即使它不含有一個可啟動的操作。不過未來這個分區也許會有一個操作系統的。

超級塊：包含文件系統的所有關鍵參數，在電腦啟動時會將超級塊讀入記憶體。這些資訊包括：確定文件系統類型用的魔數、文件系統中塊的數量以及其他重要的管理信息。

空閒管理塊：使用位圖表示系統中空閒塊的信息。

i節點：數據結構數組，每個文件一個，

### 4.3.2 文件的實現

#### 1. 連續分配

使用連續的塊將文件存儲在硬碟上。

優點：

* 實現簡單，記錄每個文件用到的硬碟只需要使用兩個數字即可：第一塊的硬碟地址和文件的塊數。
* 操作系能較好，因為單個操作就可以讀出整個文件，只要找到一次，不需要額外的尋道和旋轉延遲，數據以硬碟全帶寬的速率輸入。

缺點：

* 隨著使用時間的推移，硬碟會變得零碎。
* 為了解決這個問題，文件就必須事先知道最後的大小。

這個方案在CD或DVD中，是一個特別好的解法。

#### 2. 鏈表分配

使用鏈表的方式記錄文件

優點：可以充份利用碎片空間，且只要找到第一塊的地址，就可以找到其他位置。

缺點：

* 隨機訪問相當慢，因為每次訪問第n塊，都必須從頭找起。
* 指針占用文件的額外空間，使得部分系統操作變得相當慢。

#### 3. 採用記憶體中的表進行鏈表分配

將鏈表分配的文件塊的指針放到記憶體中的一個表中，就可以解決上面的問題。

這個表稱作文件分配表（File Allocation Table, FAT)

#### 4. i節點

這個方案在每個文件中加入一個i節點的數據結構。

i節點中列出了文件屬性和文件塊的硬碟地址。

只有在文件打開時，這個數據結構才會在記憶體中。

如果每個i節點占有n個字節，最多k個文件同時打開，那麼記憶體只要事先保留kn個字節的空間即可。

如果文件使用的硬碟塊超過了i節點所存儲的數量，就使用最後一個硬碟地址指向一個包含額外硬碟塊地址的硬碟塊。

### 4.3.3 目錄的實現

目錄的主要功能是把ASCII文件名映射成定位文件數據所需的信息。

 一種設計是文件屬性可以存放在目錄項中。目錄中有一個固定大小的目錄目項列表，每個文件對應一項，其中包含一個（固定長度）文件名、一個文件屬性的結構體以及用以說明硬碟塊位置的一個或多個硬碟地址。

一種設計是把文件屬性存放在i節點中而不是目錄項中。這樣目錄項會更短，只有文件名和i節點號。

文件名可以是固定長度也可以是不固定長度。

文件名可以記錄在目錄項的最後面，使用文件項來指向文件名

如果目錄中的文件較多時，可以使用hash表來加速查找。

### 4.3.4 共享文件

共享文件使用鏈接來實現。

文件系統本身是一個有向無環圖（Directed Acyclic Graph, DAG）

問題：

鏈接文件時，必須把鏈接的文件的硬碟地址複制到目地目錄中。修改文件內容時，新的數據將只會修改目錄目錄中的文件塊，其他用戶是不知情的，這樣就違背了共享的目地。

解法：

一、硬碟塊不列入目錄中，而是列入一個與文件本身關聯的小型數據結構中。目錄將指向這個小型數據結構。

二、使用符號鏈接的方式，讓系統建立一個類型為link的文件，並把這個文件放在目的目錄下，使得來源與目的存在鏈接。這個文件只包含鏈接文件的路徑名。當目的目錄讀該文件時，操作系統查看要讀的文件是一個link類型，則找到該文件所鏈接的文件的名字，並且讀取該文件。

### 4.3.5 日誌結構文件系統

Log-structured File System, LFS

為了解決硬碟的速度瓶頸而開發出來的。

要寫入硬碟的內容會先存在一個日誌空間中，等到該空間滿了以後，才會一次性的寫入硬碟。

當文件內容有改變時，就會在這個日誌空間中的末尾append一個段，而不是立刻寫入文件i-node指向的儲存塊。

這個段中記錄了i-node、目錄塊、數據塊，藉著這些資訊，來更新i-node所指向的硬碟位置的資料。

因為文件是分散的，所以無法定位i-node，所以定位i-node的方法是必須透過放在硬碟開頭的i-map，裡面的表項記錄了i-node編號組成的索引。這個表會讀到記憶體中，速度會更快。

會有一個清理線程負責找出無效的i-node或是文件塊。

### 4.3.6 日誌文件系統

從移除文件了解日誌文件系統，移除文件需要三個步驟：

1）在目錄中刪除文件

2）釋放i-node到空閒i-node池

3）將所有硬碟塊歸還空閒硬碟塊池

如果系統產生崩潰的情況下，上面三個步驟的任一步驟都會造成其他步驟無法正常完成，而造成資源浪費。

日誌文件系統則先寫一個日志項，列出三個將要完成的動作。然後日誌項被寫入硬碟（並為了良好地實施，可能從硬碟讀回來驗證它的完整性）。只有當日志項已經被寫入，不同的操作才可以進行。當所有的操作成功後，擦除日誌項。

如果系統這時崩潰，系統恢復後，文件系統可以通過檢查日誌來查看是不是有未完成的操作。有的話就可以通過日誌來運作未完成的動作。

被寫入的操作必須是冪等的，這意味著只要有必要，它們就可以重複很多次，並不會帶來破壞。

例如：“更新位表並標記i節點k或者塊n是空閒的”

日誌文件系統必須安排它們的數據結構和可寫危日誌的操作以使它們都是冪等的。

為了增加可靠性，一個文件系統可引入原子事務（atomic transaction）的概念。一組動作可以被界定在開始和結束事務之間，因此文件系統就必須完成所有需要的動作或是什麼都不做。

### 4.3.7 虛擬文件系統

在一個操作統下，使用不同的文件系統。

UNIX就實現了這個操作。

使用了虛擬文件系統概念嘗試將多種文件系統統一成一個有序的結構，關鍵的部分就是抽象出所有文件系統都共有的部份，並將這部分代碼放在單獨的一層，該層調用底層的實際文件系統來具體管理數據。

所有和文件相關的系統調用在最初的處理上都指向虛擬文件系統。這些來自用戶進程的調用，都是標準的POSIX系統調用，比如open、read、write和lseek等。因此VFS對用戶進程有一個“上層”接口，它就是著名的POSIX接口。

![image-20200731195734308](/home/jackyfeng/GoogleDrive/電子書/學習筆記/os-graph4-18.jpg)

運作：

一、系統啟動，根文件系統在VFS中注冊。其他文件系統裝載時，也需要向VFS注冊。

二、提供VFS函數需要的地址列表，可以是一個長的調幃矢量（表），每個VFS對象一個。如此一來，只要一個文件系統在VFS注冊，VFS就知道如何從它那裡讀一個塊--從文件系統提供的矢量中直接調用任何一個功能。

三、解析路徑並找到文件的根目錄

四、創建v節點並調用實際文件系統，以返回所有的在文件i節點中的信息。這些信息包含調用v節點操作的函數表的指針，比如read、write和close等。

五、VFS將文件描述符指向剛創建的v節點

六、VFS向調用者返回文件描述符，所以調用者可以用它去讀、寫或關閉文件。

七、當進程用文件描述符進程一個讀操作，VFS通過進程表和文件描述符表確定v節點的位置，並跟隨指針指向函數表（這是被請求文件所在的實際文件系統中的地址）。這樣就調用了處理read的函數，運行在實際文件系統中的代碼並得到所請求的塊。



通過VFS，加入新的文件系統變得相當直接。設計者首先獲得一個VFS期待的功能調用的列表，然後編寫文件系統實現這些功能。

## 4.4 文件系統管理優化

### 4.4.1 硬碟空間管理

存儲一個n字節的文件有兩種策略

一、分配n個字節的連續硬碟空間

二、把文件分成多個連續或不連續的塊。

#### 1. 塊大小

塊越大，小文件浪費的空間就越多

塊越小，文件跨越的塊就越多，導致尋道的次數變多，降低了性能。

#### 2. 記錄空閒塊

追踪空閒塊的方法：

一、採用硬碟塊鏈表，鏈表的每個塊中包含可能多的空閒硬碟塊號。對於1KB大小的塊和32位的硬碟塊號，空閒表中每個塊包含有255個空閒塊的塊號（需要有一個位置存放下一個塊的指針）

所以一個1TB的硬碟就需要10億個硬碟塊，大約用掉400萬個塊，約4GB的空間

二、採用位圖來管理空閒區。n個塊的硬碟需要n位位圖。空閒用1表示，已分配用0表示。

對於1TB的硬碟來說，需要10億位來表示，大約需要130000個1KB塊

1024×1024×1024÷1024÷8 = 131072

很明顯比使用鏈表來得少。

#### 3. 硬碟配額

為了防止人們貪心而占有太多空間，多用戶操作系統常常提供一種強制性硬碟配額機制。

其思想是系統管理員分給每個用戶擁有文件和塊的最大數量，操作系統確保每個用戶不超過分給他們的配額。

當用戶打開文件時，系統找到文件屬性和硬碟地址，並把它們送入記憶體中的打開文件表。其中一個屬性告訴文件所有者是誰。任何有關該文件大小的增長都記到所有者的配額上，以防止一個用戶壟斷所有i節點。

第二張表包含了每個用戶當前打開文件的配額記錄，即使是其他人打開該文件也一樣。該表的內容是從被打開文件的所有者的硬碟配額文件中提取出來的。當所有的文件關閉時，該記錄被寫回配額文件。

當有打開文件表中建立一新表項時，會產生一個指向所有者配額記錄的指針，以便很容易找到不同的限制。每一次往文件中添加一塊時，文件所有者所用數據塊的總數也增加，引發對配額硬限制和軟限制檢查。可以超出軟限制但不可以超過硬限制。達到硬限制時，再添加就會引發錯誤。同時文件數目也存在著類似限制的檢查。

用戶試圖登錄時，系統核查配額文件，查看該用戶文件數目或硬碟塊數目是否超過軟限制。如果超過了任一限制，則顯示一個警告，保存的警告數減1。如果該計數已為0，表示用戶多次忽略該警告，因而將不允許能用戶登錄。

打開文件表

* 屬性
* 硬碟地址
* 用戶 = 8 
* 配額指針---->指向配額表

配額表

* 軟塊限制
* 硬塊限制
* 塊的當前編號
* 剩餘塊數通知
* 軟文件限制
* 硬文件限制
* 文件的當前編號
* 剩餘文件數通知

### 4.4.2 文件系統備份

備份的重要性：

一） 從意外的災難中恢復

二）從錯誤的操作中恢復：用戶意外的刪除了文件

錯誤的操作可以利用回收站，用戶操作錯誤時，可以自行復原。

增量備份：對沒更改的文件做備份無疑是一種浪費

備份是否要壓縮必須慎重考慮，因為有可能一個壞點導致整個文件甚至整個磁帶無法讀取。

對活動文件做備份是很困難的，可能會導致不一致。因此，會先記下文件系統的瞬時快照，即複制關鍵的資料結構，然後需要把將來對文件和目錄所做的修改複制到塊中，這樣待以後有空閒時在備份。

備份必須放在不同地點，必免一個災難毀掉全部的文件及備份。



物理轉儲：直接拷貝整顆硬碟，但需要考慮壞軌複制的問題。

邏輯轉儲：使用一個特殊格式儲存文件首目錄在某個基準日期的備份，並遞歸的更改的文件和目錄。通過計算新增或是有無修改的文件目錄，來備份文件到另一個文件系統。

### 4.4.3 文件系統的一致性

### 4.4.4 文件系統性能

改善存取時間的方法：

#### 1. 高速緩存

最常用的減少硬碟訪問次數技術是`塊高速緩存（block cache)`或者`緩沖區高速緩存（buffer cache)`。

高速緩存指的是一系列的塊，它們在邏輯上屬於硬碟，但實際上基於性能的考慮被保存在記憶體中。

管理高速緩存的算法：

檢查全部的讀請求，查看在高速緩存中是否有所需要的塊。如果存在，可執行讀操作而無須訪問硬碟。如果該塊不在高速緩存中，首先要把它讀到高速緩存，再複制到所需地方。之後，對同一個塊的請求都通過高速緩存完成。

使用Hash表來快速確認所需要的塊是否存在。 

如果高速緩存滿了，則需要將用不到的塊移出高速緩存。

#### 2. 塊提前讀

在用到塊之前，試圖提前將其寫入高速緩存，從而提高命中率。

但如果文件是使用隨機存取的，就有可能幫倒忙。

因此必須先追踪文件是順序訪問方式還是隨機訪問方式。通過設置順序訪問位來表示文件的讀取方式。

### 3. 減少硬碟臂運動

把有可能順序訪問的塊放在一起，當然最好是在同一個柱面上，從而減少硬碟臂的移動次數。

為了減少讀取i節點再去讀取數據的時間，改進方法是每個柱面有自己的i節點、數據塊、空閒表。

#### 4. 硬碟碎片整理

## 4.5 文件系統實例

### 4.5.1 MS-DOS文件系統

FAT-12 分區最大為2^12^×512字節（實際上只有4086×512字節，因為有10個硬碟地址被用作特殊的標記，如文件的結尾、環塊等）。最大的硬碟分區大小為2MB，而記憶體裡的FAT表項中有4096個項，每項2字節。

FAT-16 使用16位的硬碟指針，且允許8KB、16KB、32KB的塊大小。最大支援的分區是2GB（64K個項，每個項32KB），支援最大8GB的硬碟，即4個分區，每個分區2GB。

FAT-32 有28位硬碟地址。